<!DOCTYPE html>
<html>
<head>
	<title>Fween</title>
	<style>
		body {
			font-family: sans-serif;
			font-size: 12pt;
		}
		
		.preview {
			#canvas {
			}
		}

		.container {
			box-sizing: border-box;
			width: 300px;
			height: 20px;
			border: 1px solid #333333;
			position: relative;
		}
		
		.box {
			box-sizing: border-box;
			border: 1px solid #ffffff;
			width: 40px;
			top: 0;
			bottom: 0;
			background: #aaaaaa;
			position: absolute;
		}
		
		.description {
			margin: 1em 0 0 0;
		}

		.buttons {
			margin: 1em 0 0 0;
		}
		
		.button {
			border: 1px outset #999999;
			padding: 10px;
			background: #bbbbbb;
			display: inline-block;
			cursor: pointer;
			font-size: 0.5em;
			text-transform: uppercase;
		}
	</style>
</head>
<body onload="setup();">
	<!-- <script src="../../js-es5/fween.min.js"></script> -->
	<script src="../../js-es5/fween.js"></script>
	<script>
		
		function setup() {
			console.log("Fween is " + Fween + ", Easing is " + Easing);
			
			// Instances
			window.transitionSelector = document.querySelector("#parameterTransition");

			// Listeners
			document.querySelector("#buttonToggle").addEventListener("click", function(e) { animateToggle(); });
			document.querySelector("#buttonStart").addEventListener("click", function(e) { animateToStart(); });
			document.querySelector("#buttonEnd").addEventListener("click", function(e) { animateToEnd(); });
			window.transitionSelector.addEventListener("change", function(e) { drawTransitionPreview(); });
			
			// Transition parameters
			window.transitions = {
				"spring" : window.customEaseSpring,
				"custom pow (2)" : function(t) { return window.customEaseOutPow(t, 2); },
				"custom pow (3)" : function(t) { return window.customEaseOutPow(t, 3); },
				"custom pow (4)" : function(t) { return window.customEaseOutPow(t, 4); },
				"custom pow (6)" : function(t) { return window.customEaseOutPow(t, 6); },
				"custom expo (6)" : function(t) { return window.customEaseOutExpo(t, 6); },
				"custom expo (10)" : function(t) { return window.customEaseOutExpo(t, 10); },
				"custom pow (20)" : function(t) { return window.customEaseOutPow(t, 20); },
				"custom expo (20)" : function(t) { return window.customEaseOutExpo(t, 20); },
				"Easing.expoOut" : Easing.expoOut,
				"Easing.backOut" : Easing.backOut,
				"Easing.backOut (BIG)" : function(t) { return Easing.backOut(t, 10) },
			};

			for (var key in window.transitions) {
				var option = document.createElement("option");
				option.text = key;
				transitionSelector.add(option);
			}
			window.transitionSelector.selectedIndex = 0;

			// Needed objects
			window.box2obj = {left: 0};
			window.updateBox2();
			
			window.lastTarget = 0;
			
			animateToggle();
			drawTransitionPreview();
		}
		
		// Aux functions
		function updateBox2() {
			window.requestAnimationFrame(window.updateBox2);
			document.querySelector("#box2 .box").style.left = window.box2obj.left + "px"; // TODO: getter/setter must understand px/%/em/etc
		}
		
		function getBox1Left() {
			return parseFloat(document.querySelector("#box1 .box").style.left) || 0; // TODO: getter/setter must understand px/%/em/etc
		}

		function setBox1Left(value) {
			document.querySelector("#box1 .box").style.left = value + "px";
		}
		
		// Custom easings
		function customEaseOutPow(t, v) {
			return (1-Math.pow(1-t, v));
		}

		function customEaseOutExpo(t, v) {
			return 1 - Math.pow(2, -v * t) + t * Math.pow(2, -v);
		}

		function customEaseSpring(t) {
			var bounces = 8;
			var strength = 0.5;
			var friction = 0.5; // 0-1+
			var speed = 0.5; // 0-1
			
			friction *= bounces * 2;

			var PI = Math.PI;
			var HALF_PI = PI * 0.5;
			
			//var nt = Math.pow(t, compression+1);
			//nt = (1-nt)*Math.pow(t, nt);
			
			//nt = Math.sin(t * HALF_PI)
			
			// Almost there
			//var n = 0.4;
			//nt = (1-Math.pow(1-t,n)) * (1-t) + (1-Math.pow(1-t, n));
			//return nt;
			
			var n = (1-speed) * bounces;
			var nt = (1 - customEaseOutExpo(1-t, n));
			//return nt;
			
			var top = Math.sin(nt * PI * bounces * 2) * (1-nt) * strength;
			var str = Math.pow(1-nt, friction);
			
			//return str * top + 1;
			
			// return (t < (1 / bounces / 2) ? Math.sin(t * PI * bounces * 1) : 1) * (str * top + 1);
			// return (t < (1 / bounces / 4) ? Math.sin(t * PI * bounces * 2) : 1) * (str * top + 1);
			//return (t < (1 / bounces / speed / 2) ? Math.sin(t * PI * bounces * speed) : 1) * (str * top + 1);
			return (1-Math.pow(1-nt, bounces * (20 + bounces))) * (str * top + 1);
		}
		
		function drawTransitionPreview() {
			var transition = window.transitions[window.transitionSelector.value];

			var canvas = document.querySelector("#canvas");
			var context = canvas.getContext("2d");
			
			var cm = 100;
			var cw = 300;
			var ch = 200;
			
			canvas.width = cw;
			canvas.height = ch + cm * 2;
			
			context.clearRect(0, 0, canvas.width, canvas.height);
			
			// Guidelines
			context.lineWidth = 1;
			context.strokeStyle = "#aaaaaa";
			context.beginPath();

			context.moveTo(0, cm);
			context.lineTo(cw, cm);
			context.moveTo(0, ch + cm);
			context.lineTo(cw, ch + cm);
			context.stroke();

			// Actual equation
			context.strokeStyle = "#333333";
			context.beginPath();

			var dx, dy;
			for (var i = 0; i <= cw; i++) {
				dx = i;
				dy = cm + ch * (1 - transition(i / cw));
				if (i == 0) {
					context.moveTo(dx, dy);
				} else {
					context.lineTo(dx, dy);
				}
			}

			context.stroke();
			
		}
		
		// Animation functions
		function animateToggle() {
			if (window.lastTarget > 0) {
				animateToStart();
			} else {
				animateToEnd();
			}
		}
		function animateToEnd() {
			animateTo(document.querySelector(".box").offsetParent.clientWidth - document.querySelector(".box").offsetWidth);
		}
		function animateToStart() {
			animateTo(0);
		}
		
		function animateTo(value) {
			window.lastTarget = value;

			// Select the transition
			var transition = window.transitions[window.transitionSelector.value];
			
			// Animate

			// 1: Getter/setter
			Fween.use(window.getBox1Left, window.setBox1Left).to(value, 1, transition).play();

			// 2: Object
			//Fween.use(window.box2obj).to({left: value}, 1, Easing.expoOut).play(); // TODO: onupdate

			// 3: Style object
			//Fween.use(document.querySelector("#box4 .box").style).to({"left": value+"px"}, 1, Easing.expoOut).play();

			// 4: CSS Transition
			//Fween.use(document.querySelector("#box4 .box")).to("left: "+value+"px", 1, "ease-out").play();
		}
	</script>
	<div>
		<div class="parameters">
			<div class="description">Parameters:</div>
			<select id="parameterTransition">
			</select>
		<div>

		<div class="preview">
			<canvas id="canvas"></canvas>
		</div>

		<div class="description">Tweening with abstract getter/setter:</div>
		<div id="box1" class="container"><div class="box"></div></div>

		<div class="description">Tweening with abstract object properties:</div>
		<div id="box2" class="container"><div class="box"></div></div>

		<div class="description">Tweening with element style object:</div>
		<div id="box3" class="container"><div class="box"></div></div>

		<div class="description">Tweening with CSS transitions:</div>
		<div id="box4" class="container"><div class="box"></div></div>

		<div class="buttons">
			<div id="buttonToggle" class="button">Animate (toggle)</div>
			<div id="buttonStart" class="button">Animate to start</div>
			<div id="buttonEnd" class="button">Animate to end</div>
		</div>
	<div>
</body>
</html>